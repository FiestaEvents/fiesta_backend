name: Deploy Backend (DEV)

on:
  push:
    branches: [ dev ] # <--- Triggers only on 'dev' branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Copy files via SSH
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        source: "."
        target: "/var/www/fiesta_dev/server"
        rm: false

    - name: Deploy Backend
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /var/www/fiesta_dev/server
          npm ci --production
          
          # We use the full PM2 path you found earlier
          PM2_PATH=/root/.nvm/versions/node/v22.21.1/bin/pm2
          
          # Start/Reload 'api-dev' (Distinct name from 'api')
          $PM2_PATH reload api-dev --update-env || $PM2_PATH start src/index.js --name "api-dev"
          $PM2_PATH save